<!DOCTYPE html>
<html lang="en-US">
<head>
	<title>G-Code post-processor</title>
	<link href="./assets/gcodepost.css" rel="stylesheet" type="text/css">
</head>
<body>
	<h1>G-Code post-processor</h1>	
	<table id="gcodeBlock">
		<tbody>
			<tr>
				<td class="leftCells">
					Insert G-Code or pick a file: <input id="inFile" onchange="loadFileAsText()" type="file" accept=".gcode, .g-code, .nc">
				</td>
				<td class="rightCells">
					Modified G-Code will appear here: <button id="save" onclick="saveTextAsFile()">Save</button>
				</td>
			</tr>
			<tr>
				<td class="leftCells">
					<textarea id="gcode"></textarea>
				</td>
				<td class="rightCells">
					<textarea readonly="readonly" id="finalgcode"></textarea>
				</td>
			</tr>
		</tbody>
	</table>
	<label for="cars">Choose an post-processing option:</label>
	<select id="editOption" onchange="showForm(this.value)">
			<option value="0" selected>--Choose an option--</option>
			<option value="1">Convert Laser G-Code (LaserGRBL) to use on Ender 3 V2 (grayscale)</option>
			<option value="2">Convert Laser G-Code (LaserGRBL) to use on Ender 3 V2 (outline)</option>
	</select>
	<div id="spacer"></div>
	<div class="formDiv" style="display: none"></div>
	<div class="formDiv" style="display: none">
		<div class="feature-description">This function converts the code generated by LaserGRBL for laser PWM grayscale engraving to a format compatible with the Ender 3 V2; Marlin 2, the firmware of the printer, can't achieve the high frequency pulse width modulation required for grayscale laser engraving (<a href="https://github.com/MarlinFirmware/Marlin/issues/20638">[BUG] HW PWM not working for stm32f1 PA0 #20638</a>), thus this function will convert the PWM commands to feed rate commands, making the head go faster on light areas and slower on dark areas of the image, resulting in a decent grayscale engraving. Tuning the parameters below requires some trial and error process.<br>Min. and max. feed rate will be used while engraving: max. feed rate will be used for white areas, min. feed rate for black areas and intermediate, remapped values will be used for grey areas.<br>To correctly generate the g-code, use LaserGRBL's default settings (Firmware: GRBL; Support PWM: on), and choose "Line to line tracing" when importing the image.</div>
		<div class="control">
			<br>
			<label for="minSpeed">Min. Feed rate (mm/min):</label><input id="minSpeed" type="number" value="400" min="60" max="3000"></input>
			<label for="maxSpeed">Max. Feed rate (mm/min):</label><input id="maxSpeed" type="number" value="4000" min="600" max="30000"></input>
		</div>
		<div class="control">Pause after turning on the laser (ms):
			<input id="pauseOn" type="number" value="120" min="0" max="1000"></input>
		</div>
		<div class="control">Pause after turning off the laser (ms):
			<input id="pauseOff" type="number" value="120" min="0" max="1000"></input>
		</div>
		<div class="control">Time multiplier (e.g. "2" will double the time of engraving, resulting in a darker image):
			<input id="timeMultiplier" type="number" value="1" min="0.01" max="10"></input>
		</div>
		<div class="control">Click to convert from LaserGRBL grayscale to Ender 3 grayscale:
			<button id="pwm" onclick="laserPWMtoSpeed()">PWM to Feed Rate</button>
		</div>
	</div>
	<div class="formDiv" style="display: none">
		<div class="feature-description">This function converts the code generated by LaserGRBL for laser outline engraving/cutting to a format compatible with the Ender 3 V2; Marlin 2 on Ender 3 uses the M106/M107 commands to control the laser, instead of the M3/M5 used by other systems, thus this function operates this conversion. It also adds the G commands to each line where the coordinates are found, as needed by Marlin.<br>To correctly generate the g-code, use LaserGRBL's default settings (Firmware: GRBL; Laser ON: M3; Laser OFF: M5; S-Min: 0; S-max: 255).</div>
		<div class="control">Pause after turning on the laser (ms):
			<input id="pauseOnOut" type="number" value="120" min="0" max="1000"></input>
		</div>
		<div class="control">Pause after turning off the laser (ms):
			<input id="pauseOffOut" type="number" value="120" min="0" max="1000"></input>
		</div>
		<div class="control">Click to convert from LaserGRBL outline to Ender 3 outline:
			<button id="toE3" onclick="outlineGRBLtoEnder()">LaserGRBL to Ender 3</button>
		</div>
	</div>
	<footer style="text-align: right; padding-top: 3em; font-style: italic; font-size: 11pt">
	Created by Stefano Panzeri, 2024
	</footer>
	<script type="text/javascript" src="./assets/gcodepost.js"></script>
</body>
</html>
